<!DOCTYPE html>
<html>
<head>
    <title>InsightFace Gender Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #0b0c10;
            color: #e5e7eb;
        }
        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
            background: transparent;
            box-shadow: none;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .video-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 100px);
            margin-top: 100px; /* space for top bar */
            overflow: hidden;
            background: #000;
        }
        #processedImage {
            max-width: 100% !important;
            max-height: 100% !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: relative;
            background: #000;
        }
        
        #processedImage {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        #canvas {
            display: none;
        }
        .controls { display: none; }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            margin: 0 8px;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .status.running {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.stopped {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #e2e3e5;
            padding: 15px;
            border-radius: 3px;
            margin: 20px 0;
        }
        .results { display: none; }
        .face-result {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-left: 4px solid #007bff;
            border-radius: 3px;
        }
        .face-result.male {
            border-left-color: #2196F3;
        }
        .face-result.female {
            border-left-color: #E91E63;
        }
        .confidence-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 5px 0;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .age-info {
            color: #4a90e2;
            font-weight: bold;
            margin: 5px 0;
            font-size: 0.9em;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .performance-panel { display: none; }
        .performance-panel h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 18px;
        }
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .perf-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        .perf-label {
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        .perf-value {
            font-weight: 600;
            color: #007bff;
            font-size: 14px;
            padding: 2px 8px;
            background: #e3f2fd;
            border-radius: 3px;
        }
        .perf-value.optimized {
            color: #28a745;
            background: #d4edda;
        }
        .perf-value.active {
            color: #17a2b8;
            background: #d1ecf1;
        }
        .perf-value.ready {
            color: #ffc107;
            background: #fff3cd;
        }
        .testing-panel {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #bee5eb;
        }
        .testing-panel h3 {
            margin: 0 0 15px 0;
            color: #0c5460;
            font-size: 18px;
        }
        .test-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .test-controls button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-controls button:hover {
            background: #138496;
        }
        .test-controls button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .test-results {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .test-results h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .detection-log {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin: 5px 0;
            border-left: 4px solid #ffc107;
            max-height: 200px;
            overflow-y: auto;
        }
        .detection-log-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        .detection-log-panel h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 18px;
        }
        .log-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .log-controls button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .log-controls button:hover {
            background: #5a6268;
        }
        #detectionLogDisplay {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #4a5568;
        }
        /* Top bar (floating metrics + controls) */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 84px;
            background: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 1000;
        }
        .brand-title { font-size: 16px; font-weight: 600; color: #e5e7eb; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .metrics-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .metric-chip {
            background: rgba(31, 41, 55, 0.9);
            color: #e5e7eb;
            border: 1px solid rgba(255,255,255,0.08);
            padding: 6px 10px;
            border-radius: 9999px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .metric-chip strong { color: #93c5fd; font-weight: 600; }
        .chip-ok { background: rgba(22, 101, 52, 0.35); border-color: rgba(34,197,94,0.35); }
        .chip-warn { background: rgba(180, 83, 9, 0.35); border-color: rgba(245,158,11,0.35); }
        .chip-info { background: rgba(30, 64, 175, 0.35); border-color: rgba(59,130,246,0.35); }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="brand-title">InsightFace Gender & Age</div>
        <div class="control-group">
            <button id="tbStart" onclick="startDetection()">Start</button>
            <button id="tbStop" onclick="stopDetection()" disabled>Stop</button>
            <button id="tbFlip" onclick="flipCamera()" disabled>Flip</button>
            <button id="tbDebug" onclick="toggleDebugMode()">Debug</button>
            <select id="detectorSelect" onchange="applyModelSelection()">
                <option value="insightface">Detector: InsightFace</option>
                <option value="yunet">Detector: YuNet (CPU)</option>
            </select>
            <select id="classifierSelect" onchange="applyModelSelection()">
                <option value="insightface_gender">Classifier: InsightFace</option>
                <option value="mobilenet_gender">Classifier: MobileNet</option>
            </select>
        </div>
        <div class="metrics-group">
            <div class="metric-chip chip-info"><strong>Mode</strong> <span id="modeChip">Init</span></div>
            <div class="metric-chip"><strong>FPS</strong> <span id="fpsChip">0</span></div>
            <div class="metric-chip"><strong>Faces</strong> <span id="facesChip">0</span></div>
            <div class="metric-chip"><strong>Tracked</strong> <span id="trackedChip">0</span></div>
            <div class="metric-chip chip-ok"><strong>Status</strong> <span id="statusChip">Stopped</span></div>
        </div>
    </div>

    <div class="container">
        
        
        <div class="video-container">
            <video id="videoElement" autoplay muted style="display: none;"></video>
            <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
            <img id="processedImage" style="display: none; max-width: 100%; border: 2px solid #ddd; border-radius: 5px;">
            <div id="loading">Click "Start Detection" to begin</div>
        </div>
        
        <div class="controls">
            <button id="startBtn" onclick="startDetection()">Start Detection</button>
            <button id="stopBtn" onclick="stopDetection()" disabled>Stop Detection</button>
            <button id="flipBtn" onclick="flipCamera()" disabled>üîÑ Flip Camera</button>
            <button id="testBtn" onclick="testWithImage()" disabled>üì∑ Test with Image</button>
            <button id="screenshotBtn" onclick="takeScreenshot()" disabled>üì∏ Screenshot</button>
        </div>
        
        <div class="testing-panel">
            <h3>üß™ Testing & Debug Tools</h3>
            <div class="test-controls">
                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <button onclick="document.getElementById('imageInput').click()" id="uploadBtn" disabled>üìÅ Upload Test Image</button>
                <button onclick="clearTestData()" id="clearBtn" disabled>üóëÔ∏è Clear Test Data</button>
                <button onclick="toggleDebugMode()" id="debugBtn">üêõ Debug Mode: OFF</button>
            </div>
            <div class="test-results" id="testResults" style="display: none;">
                <h4>Test Results:</h4>
                <div id="testOutput"></div>
            </div>
        </div>
        
        <div id="status" class="status stopped">
            Status: Stopped
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="faceCount">0</div>
                <div class="stat-label">Faces Detected</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="maleCount">0</div>
                <div class="stat-label">Male</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="femaleCount">0</div>
                <div class="stat-label">Female</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="fps">0</div>
                <div class="stat-label">FPS</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="trackedFaces">0</div>
                <div class="stat-label">Tracked Faces</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="processingTime">0ms</div>
                <div class="stat-label">Processing Time</div>
            </div>
        </div>
        
        <div class="performance-panel">
            <h3>üöÄ Performance & Tracking</h3>
            <div class="performance-grid">
                <div class="perf-item">
                    <span class="perf-label">Model Status:</span>
                    <span class="perf-value" id="modelStatus">Initializing...</span>
                </div>
                <div class="perf-item">
                    <span class="perf-label">Detection Mode:</span>
                    <span class="perf-value" id="detectionMode">Full Detection</span>
                </div>
                <div class="perf-item">
                    <span class="perf-label">Frame Skip:</span>
                    <span class="perf-value" id="frameSkip">Every 3rd frame</span>
                </div>
                <div class="perf-item">
                    <span class="perf-label">Memory Usage:</span>
                    <span class="perf-value" id="memoryUsage">Optimized</span>
                </div>
                <div class="perf-item">
                    <span class="perf-label">CPU Optimization:</span>
                    <span class="perf-value" id="cpuOptimization">Active</span>
                </div>
                <div class="perf-item">
                    <span class="perf-label">Tracking Status:</span>
                    <span class="perf-value" id="trackingStatus">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="results">
            <h3>Detection Results:</h3>
            <div id="results">No faces detected</div>
        </div>
        
        <div class="detection-log-panel" id="detectionLogPanel" style="display: none;">
            <h3>üìä Real-time Detection Log</h3>
            <div class="log-controls">
                <button onclick="toggleLogPanel()" id="logToggleBtn">Hide Log</button>
                <button onclick="clearLog()" id="clearLogBtn">Clear Log</button>
                <button onclick="exportLog()" id="exportLogBtn">Export Log</button>
            </div>
            <div class="detection-log" id="detectionLogDisplay">
                <div style="color: #666; font-style: italic;">Detection log will appear here when debug mode is enabled...</div>
            </div>
        </div>
    </div>

    <script>
        let isDetecting = false;
        let video = document.getElementById('videoElement');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let stream = null;
        let processingInterval = null;
        let frameCount = 0;
        let startTime = Date.now();
        let currentFacingMode = 'user'; // 'user' for front camera, 'environment' for back camera
        let debugMode = false;
        let detectionLog = [];
        let testImageData = null;
        let currentDetector = 'insightface';
        let currentClassifier = 'insightface_gender';
        
        async function startDetection() {
            if (isDetecting) return;
            
            // Check if getUserMedia is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = 'Status: Camera Not Supported - Use HTTPS or modern browser';
                console.error('getUserMedia not supported');
                return;
            }
            
            try {
                // Request camera access with better constraints
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: currentFacingMode
                    } 
                });
                
                // Set video source
                video.srcObject = stream;
                video.style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                
                // Wait for video to be ready
                video.onloadedmetadata = function() {
                    console.log('Video loaded, dimensions:', video.videoWidth, 'x', video.videoHeight);
                };
                
                // Update UI
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const flipBtn = document.getElementById('flipBtn');
                if (startBtn) startBtn.disabled = true;
                if (stopBtn) stopBtn.disabled = false;
                if (flipBtn) flipBtn.disabled = false;
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.className = 'status running';
                    statusEl.textContent = 'Status: Running - InsightFace Detection Active';
                }
                // Top bar controls
                const tbStart = document.getElementById('tbStart');
                const tbStop = document.getElementById('tbStop');
                const tbFlip = document.getElementById('tbFlip');
                if (tbStart) tbStart.disabled = true;
                if (tbStop) tbStop.disabled = false;
                if (tbFlip) tbFlip.disabled = false;
                const statusChip = document.getElementById('statusChip');
                if (statusChip) statusChip.textContent = 'Running';
                const modeChip = document.getElementById('modeChip');
                if (modeChip) modeChip.textContent = 'Full Detection';
                
                isDetecting = true;
                
                // Start processing frames - balanced for accuracy and Pi 5 performance
                processingInterval = setInterval(processFrame, 200); // Process every 200ms for 5 FPS (faster response)
                
                // Start memory cleanup every 30 seconds
                memoryCleanupInterval = setInterval(() => {
                    if (window.gc) {
                        window.gc();
                    }
                    console.log('Memory cleanup performed');
                }, 20000); // Cleanup every 20 seconds for better performance
                
                console.log('InsightFace detection started');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                document.getElementById('status').className = 'status error';
                
                // Show specific error messages
                if (error.name === 'NotAllowedError') {
                    document.getElementById('status').textContent = 'Status: Camera Permission Denied - Please allow camera access';
                } else if (error.name === 'NotFoundError') {
                    document.getElementById('status').textContent = 'Status: No Camera Found - Please connect a camera';
                } else if (error.name === 'NotSupportedError') {
                    document.getElementById('status').textContent = 'Status: Camera Not Supported - Try HTTPS or different browser';
                } else if (error.name === 'OverconstrainedError') {
                    document.getElementById('status').textContent = 'Status: Camera Constraints Not Met - Try different camera';
                } else {
                    document.getElementById('status').textContent = 'Status: Camera Error - ' + error.message;
                }
                
                resetUI();
            }
        }
        
        function stopDetection() {
            if (!isDetecting) return;
            
            // Stop processing
            if (processingInterval) {
                clearInterval(processingInterval);
                processingInterval = null;
            }
            
            // Stop memory cleanup
            if (memoryCleanupInterval) {
                clearInterval(memoryCleanupInterval);
                memoryCleanupInterval = null;
            }
            
            // Stop camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Update UI
            resetUI();
            const tbStart = document.getElementById('tbStart');
            const tbStop = document.getElementById('tbStop');
            const tbFlip = document.getElementById('tbFlip');
            if (tbStart) tbStart.disabled = false;
            if (tbStop) tbStop.disabled = true;
            if (tbFlip) tbFlip.disabled = true;
            const statusChip = document.getElementById('statusChip');
            if (statusChip) statusChip.textContent = 'Stopped';
            
            console.log('Detection stopped');
        }
        
        function resetUI() {
            isDetecting = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            video.style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('status').className = 'status stopped';
            document.getElementById('status').textContent = 'Status: Stopped';
            document.getElementById('results').textContent = 'No faces detected';
            
            // Reset stats
            document.getElementById('faceCount').textContent = '0';
            document.getElementById('maleCount').textContent = '0';
            document.getElementById('femaleCount').textContent = '0';
            document.getElementById('fps').textContent = '0';
            
            // Disable flip button
            document.getElementById('flipBtn').disabled = true;
        }
        
        async function flipCamera() {
            if (!isDetecting) return;
            
            try {
                // Stop current stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Toggle facing mode
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                
                // Get new stream with flipped camera
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: currentFacingMode
                    } 
                });
                
                // Set new video source
                video.srcObject = stream;
                
                // Update button text
                const flipBtn = document.getElementById('flipBtn');
                flipBtn.textContent = currentFacingMode === 'user' ? 'üîÑ Back Camera' : 'üîÑ Front Camera';
                
                console.log(`Camera flipped to: ${currentFacingMode}`);
                
            } catch (error) {
                console.error('Error flipping camera:', error);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = 'Status: Camera flip failed - ' + error.message;
            }
        }
        
        function processFrame() {
            if (!isDetecting || !video.videoWidth || !video.videoHeight) {
                console.log('Skipping frame - video not ready');
                return;
            }
            
            try {
                // Draw current frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert canvas to base64 (balanced quality for better accuracy)
                const imageData = canvas.toDataURL('image/jpeg', 0.3); // Lower quality for faster processing
                
                // Send to server for processing
                fetch('/process_frame', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData, detector: currentDetector, classifier: currentClassifier })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        displayResults(data.results);
                        updateStats(data.results);
                        updatePerformanceMetrics(data);
                        
                        // Debug logging
                        if (debugMode) {
                            logDetection('Live Camera', data);
                        }
                        
                        // Display processed image with rectangles (overlay on video for smooth feed)
                        if (data.image_with_boxes) {
                            const processedImg = document.getElementById('processedImage');
                            processedImg.src = 'data:image/jpeg;base64,' + data.image_with_boxes;
                            processedImg.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error processing frame:', error);
                    // Continue processing even if one frame fails
                });
                
                // Update FPS
                frameCount++;
                const elapsed = (Date.now() - startTime) / 1000;
                const fps = Math.round(frameCount / elapsed);
                document.getElementById('fps').textContent = fps;
                
            } catch (error) {
                console.error('Error in processFrame:', error);
                // Continue processing even if one frame fails
            }
        }
        
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            
            if (results.length === 0) {
                resultsDiv.textContent = 'No faces detected';
                return;
            }
            
            let html = '';
            results.forEach((result, index) => {
                const genderClass = result.gender.toLowerCase();
                const confidence = Math.round(result.confidence * 100);
                
                const ageText = result.age ? `Age: ${result.age}` : 'Age: Unknown';
                html += `
                    <div class="face-result ${genderClass}">
                        <strong>Face ${index + 1}: ${result.gender}</strong>
                        <div class="age-info">${ageText}</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidence}%"></div>
                        </div>
                        <small>Confidence: ${confidence}%</small>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function updateStats(results) {
            const faceCount = results.length;
            const maleCount = results.filter(r => r.gender === 'Male').length;
            const femaleCount = results.filter(r => r.gender === 'Female').length;
            const trackedCount = results.filter(r => r.tracked).length;
            
            const faceCountEl = document.getElementById('faceCount');
            const maleCountEl = document.getElementById('maleCount');
            const femaleCountEl = document.getElementById('femaleCount');
            const trackedFacesEl = document.getElementById('trackedFaces');
            if (faceCountEl) faceCountEl.textContent = faceCount;
            if (maleCountEl) maleCountEl.textContent = maleCount;
            if (femaleCountEl) femaleCountEl.textContent = femaleCount;
            if (trackedFacesEl) trackedFacesEl.textContent = trackedCount;
            const facesChip = document.getElementById('facesChip');
            const trackedChip = document.getElementById('trackedChip');
            if (facesChip) facesChip.textContent = faceCount;
            if (trackedChip) trackedChip.textContent = trackedCount;
        }
        
        function updatePerformanceMetrics(data) {
            // Update processing time if available
            if (data.processing_time) {
                const procEl = document.getElementById('processingTime');
                if (procEl) procEl.textContent = Math.round(data.processing_time) + 'ms';
            }
            
            // Update model status
            if (data.model_status) {
                const modelStatusEl = document.getElementById('modelStatus');
                modelStatusEl.textContent = data.model_status;
                modelStatusEl.className = 'perf-value optimized';
            }
            
            // Update detection mode
            if (data.detection_mode) {
                const detectionModeEl = document.getElementById('detectionMode');
                if (detectionModeEl) {
                    detectionModeEl.textContent = data.detection_mode;
                    detectionModeEl.className = data.detection_mode === 'Cached Tracking' ? 'perf-value active' : 'perf-value';
                }
                const modeChip = document.getElementById('modeChip');
                if (modeChip) modeChip.textContent = data.detection_mode;
            }
            
            // Update tracking status
            if (data.tracking_status) {
                const trackingStatusEl = document.getElementById('trackingStatus');
                trackingStatusEl.textContent = data.tracking_status;
                if (data.tracking_status === 'Active') {
                    trackingStatusEl.className = 'perf-value active';
                } else if (data.tracking_status === 'Ready') {
                    trackingStatusEl.className = 'perf-value ready';
                } else {
                    trackingStatusEl.className = 'perf-value';
                }
            }
            
            // Update memory usage
            if (data.memory_usage) {
                const memoryUsageEl = document.getElementById('memoryUsage');
                memoryUsageEl.textContent = data.memory_usage;
                memoryUsageEl.className = 'perf-value optimized';
            }
            
            // Update CPU optimization
            if (data.cpu_optimization) {
                const cpuOptimizationEl = document.getElementById('cpuOptimization');
                cpuOptimizationEl.textContent = data.cpu_optimization;
                cpuOptimizationEl.className = 'perf-value active';
            }
        }
        
        // Testing and Debug Functions
        function applyModelSelection() {
            const detSel = document.getElementById('detectorSelect');
            const clsSel = document.getElementById('classifierSelect');
            if (detSel) currentDetector = detSel.value;
            if (clsSel) currentClassifier = clsSel.value;
            const modeChip = document.getElementById('modeChip');
            if (modeChip) modeChip.textContent = (currentDetector === 'yunet' ? 'YuNet' : 'InsightFace');
        }
        function toggleDebugMode() {
            debugMode = !debugMode;
            const debugBtn = document.getElementById('debugBtn');
            const logPanel = document.getElementById('detectionLogPanel');
            const logToggleBtn = document.getElementById('logToggleBtn');
            
            debugBtn.textContent = debugMode ? 'üêõ Debug Mode: ON' : 'üêõ Debug Mode: OFF';
            debugBtn.style.background = debugMode ? '#28a745' : '#17a2b8';
            
            if (debugMode) {
                console.log('Debug mode enabled - detailed logging active');
                logPanel.style.display = 'block';
                logToggleBtn.textContent = 'Hide Log';
            } else {
                console.log('Debug mode disabled');
                logPanel.style.display = 'none';
            }
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    testImageData = e.target.result;
                    document.getElementById('testBtn').disabled = false;
                    document.getElementById('clearBtn').disabled = false;
                    console.log('Test image loaded:', file.name);
                };
                reader.readAsDataURL(file);
            }
        }
        
        function testWithImage() {
            if (!testImageData) {
                alert('Please upload an image first');
                return;
            }
            
            console.log('Testing with uploaded image...');
            document.getElementById('testResults').style.display = 'block';
            
            // Send test image to server
            fetch('/process_frame', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image: testImageData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayTestResults(data);
                    if (debugMode) {
                        logDetection('Test Image', data);
                    }
                } else {
                    document.getElementById('testOutput').innerHTML = '<p style="color: red;">Error: ' + (data.error || 'Unknown error') + '</p>';
                }
            })
            .catch(error => {
                console.error('Test error:', error);
                document.getElementById('testOutput').innerHTML = '<p style="color: red;">Error: ' + error.message + '</p>';
            });
        }
        
        function displayTestResults(data) {
            const output = document.getElementById('testOutput');
            let html = '<div class="debug-info">';
            html += '<strong>Test Results:</strong><br>';
            html += `Processing Time: ${data.processing_time ? Math.round(data.processing_time) + 'ms' : 'N/A'}<br>`;
            html += `Model Status: ${data.model_status || 'N/A'}<br>`;
            html += `Detection Mode: ${data.detection_mode || 'N/A'}<br>`;
            html += `Faces Detected: ${data.results ? data.results.length : 0}<br>`;
            html += '</div>';
            
            if (data.results && data.results.length > 0) {
                html += '<div class="detection-log">';
                html += '<strong>Face Details:</strong><br>';
                data.results.forEach((result, index) => {
                    html += `Face ${index + 1}: ${result.gender} (${Math.round(result.confidence * 100)}%)`;
                    if (result.age) html += `, Age: ${result.age}`;
                    if (result.tracked) html += ' [TRACKED]';
                    html += '<br>';
                });
                html += '</div>';
            } else {
                html += '<p style="color: orange;">No faces detected in test image</p>';
            }
            
            if (data.image_with_boxes) {
                html += '<div style="margin-top: 10px;">';
                html += '<strong>Processed Image:</strong><br>';
                html += `<img src="data:image/jpeg;base64,${data.image_with_boxes}" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px;">`;
                html += '</div>';
            }
            
            output.innerHTML = html;
        }
        
        function takeScreenshot() {
            if (!isDetecting || !video.videoWidth) {
                alert('Please start detection first');
                return;
            }
            
            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Create download link
            const link = document.createElement('a');
            link.download = `screenshot_${new Date().getTime()}.jpg`;
            link.href = imageData;
            link.click();
            
            console.log('Screenshot saved');
        }
        
        function clearTestData() {
            testImageData = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('testBtn').disabled = true;
            document.getElementById('clearBtn').disabled = true;
            document.getElementById('testResults').style.display = 'none';
            document.getElementById('testOutput').innerHTML = '';
            console.log('Test data cleared');
        }
        
        function logDetection(source, data) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${source}: ${data.results ? data.results.length : 0} faces, ${data.processing_time ? Math.round(data.processing_time) + 'ms' : 'N/A'}ms`;
            detectionLog.push(logEntry);
            
            // Keep only last 100 entries
            if (detectionLog.length > 100) {
                detectionLog.shift();
            }
            
            // Update real-time log display
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logDisplay = document.getElementById('detectionLogDisplay');
            if (detectionLog.length === 0) {
                logDisplay.innerHTML = '<div style="color: #666; font-style: italic;">Detection log will appear here when debug mode is enabled...</div>';
            } else {
                logDisplay.innerHTML = detectionLog.join('\n');
                // Auto-scroll to bottom
                logDisplay.scrollTop = logDisplay.scrollHeight;
            }
        }
        
        function toggleLogPanel() {
            const panel = document.getElementById('detectionLogPanel');
            const btn = document.getElementById('logToggleBtn');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.textContent = 'Hide Log';
            } else {
                panel.style.display = 'none';
                btn.textContent = 'Show Log';
            }
        }
        
        function clearLog() {
            detectionLog = [];
            updateLogDisplay();
            console.log('Detection log cleared');
        }
        
        function exportLog() {
            const logText = detectionLog.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `detection_log_${new Date().getTime()}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            console.log('Detection log exported');
        }
        
        // Update existing processFrame to include debug logging
        const originalProcessFrame = processFrame;
        processFrame = function() {
            const result = originalProcessFrame();
            if (debugMode && isDetecting) {
                // This will be called after the fetch completes
                setTimeout(() => {
                    // Debug info will be logged in the .then() callback
                }, 100);
            }
            return result;
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('InsightFace Gender Detection Web App loaded');
            
            // Enable test buttons when detection starts
            const originalStartDetection = startDetection;
            startDetection = async function() {
                await originalStartDetection();
                document.getElementById('testBtn').disabled = false;
                document.getElementById('screenshotBtn').disabled = false;
                document.getElementById('uploadBtn').disabled = false;
            };
            
            // Disable test buttons when detection stops
            const originalStopDetection = stopDetection;
            stopDetection = function() {
                originalStopDetection();
                document.getElementById('testBtn').disabled = true;
                document.getElementById('screenshotBtn').disabled = true;
                document.getElementById('uploadBtn').disabled = true;
            };
        });
    </script>
</body>
</html>
